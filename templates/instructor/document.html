{% extends "base.html" %}

{% block title %}Document: {{ document.title }} - Adaptive Quiz Generator{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('instructor.index') }}">Instructor</a></li>
                <li class="breadcrumb-item active">{{ document.title }}</li>
            </ol>
        </nav>
        <h2><i class="bi bi-file-earmark-text text-primary"></i> {{ document.title }}</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Document Info -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Document Details</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="reprocessDocument()">
                        <i class="bi bi-arrow-repeat"></i> Reprocess
                    </button>
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteDocModal">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Filename:</strong> {{ document.filename }}</p>
                        <p><strong>Uploaded:</strong> {{ document.uploaded_at }}</p>
                        <p><strong>Size:</strong> {{ document.size }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{{ 'success' if document.processed else 'warning' }}">
                                {{ 'Processed' if document.processed else 'Processing...' }}
                            </span>
                        </p>
                        <p><strong>Concepts Extracted:</strong> {{ document.concept_count }}</p>
                        <p><strong>Questions Generated:</strong> {{ document.question_count }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Extracted Text Preview -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-text-paragraph"></i> Extracted Text Preview</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ document.text_preview }}</pre>
            </div>
        </div>
        
        <!-- Concepts List -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Extracted Concepts</h5>
                <span class="badge bg-primary">{{ concepts | length }} concepts</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    {% for concept in concepts %}
                    <span class="badge bg-secondary fs-6">
                        {{ concept.name }}
                        <span class="badge bg-light text-dark ms-1">{{ concept.importance | round(2) }}</span>
                    </span>
                    {% else %}
                    <p class="text-muted">No concepts extracted yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('instructor.generate_quiz', doc_id=document.id) }}" class="btn btn-primary w-100 mb-2">
                    <i class="bi bi-magic"></i> Generate Quiz
                </a>
                <a href="{{ url_for('dashboard.knowledge_graph') }}" class="btn btn-outline-info w-100 mb-2">
                    <i class="bi bi-diagram-3"></i> View Knowledge Graph
                </a>
                <button class="btn btn-outline-secondary w-100" onclick="downloadConcepts()">
                    <i class="bi bi-download"></i> Export Concepts
                </button>
            </div>
        </div>
        
        <!-- Related Quizzes -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-check"></i> Related Quizzes</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for quiz in related_quizzes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('instructor.view_quiz', quiz_id=quiz.id) }}">{{ quiz.title }}</a>
                        <span class="badge bg-info">{{ quiz.question_count }} Q</span>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted text-center">No quizzes yet</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Knowledge Graph Preview -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Knowledge Graph</h5>
            </div>
            <div class="card-body p-0">
                <div id="miniGraph" style="height: 250px; background: #fafafa;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete Document</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong>{{ document.title }}</strong>"?</p>
                <p class="text-danger">This will also delete all extracted concepts and generated questions.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteDocument()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
const documentId = "{{ document.id }}";

// Mini Knowledge Graph
async function loadMiniGraph() {
    try {
        const response = await fetch(`/api/knowledge-graph?document_id=${documentId}&limit=15`);
        const data = await response.json();
        
        if (data.success && data.nodes.length > 0) {
            const container = document.getElementById('miniGraph');
            const network = new vis.Network(container, {
                nodes: new vis.DataSet(data.nodes.map(n => ({
                    id: n.id,
                    label: n.label,
                    color: '#0d6efd'
                }))),
                edges: new vis.DataSet(data.edges.map(e => ({
                    from: e.source,
                    to: e.target
                })))
            }, {
                nodes: { shape: 'dot', size: 10 },
                edges: { width: 1 },
                interaction: { dragNodes: false, zoomView: false },
                physics: { stabilization: true }
            });
        } else {
            document.getElementById('miniGraph').innerHTML = '<div class="p-3 text-center text-muted">No graph data</div>';
        }
    } catch (error) {
        console.error('Error loading graph:', error);
    }
}

async function reprocessDocument() {
    if (!confirm('Reprocess this document? This will re-extract all concepts.')) return;
    
    try {
        const response = await fetch(`/api/documents/${documentId}/reprocess`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to reprocess');
        }
    } catch (error) {
        alert('Error reprocessing document');
    }
}

async function deleteDocument() {
    try {
        const response = await fetch(`/api/documents/${documentId}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
            window.location.href = "{{ url_for('instructor.index') }}";
        } else {
            alert(data.error || 'Failed to delete');
        }
    } catch (error) {
        alert('Error deleting document');
    }
}

function downloadConcepts() {
    window.location.href = `/api/documents/${documentId}/export-concepts`;
}

document.addEventListener('DOMContentLoaded', loadMiniGraph);
</script>
{% endblock %}
